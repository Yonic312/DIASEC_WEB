<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.diasec.diasec_backend.dao.OrderMapper">

    <!-- OrderVo 속성 정의 -->
    <resultMap id="orderMap" type="OrderVo">
        <id property="oid" column="oid"/>
        <result property="id" column="id"/>
        <result property="ordererName" column="orderer_name"/>
        <result property="ordererPhone" column="orderer_phone"/>
        <result property="email" column="email"/>
        <result property="recipient" column="recipient"/>
        <result property="postcode" column="postcode"/>
        <result property="address" column="address"/>
        <result property="detailAddress" column="detail_address"/>
        <result property="usedCredit" column="used_credit"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="depositor" column="depositor"/>
        <result property="bankAccount" column="bank_account"/>
        <result property="receiptType" column="receipt_type"/>
        <result property="receiptInfo" column="receipt_info"/>
        <result property="receiptMethod" column="receipt_method"/>
        <result property="totalPrice" column="total_price"/>
        <result property="totalDeposit" column="total_deposit"/>
        <result property="deliveryFee" column="delivery_fee"/>
        <result property="buyerRequest" column="buyer_request"/>
        <result property="deliveryMessage" column="delivery_message"/>
        <result property="finalPrice" column="final_price"/>
        <result property="createdAt" column="created_at"/>
        <result property="recipientPhone" column="recipient_phone"/>
        <result property="guestPassword" column="guest_password"/>
    </resultMap>

    <!-- orders 테이블에 주문 저장 -->
    <insert id="insertOrder" parameterType="OrderVo" useGeneratedKeys="true" keyProperty="oid">
        INSERT INTO orders (
            id, orderer_name, orderer_phone, email, recipient, postcode, address, detail_address,
            used_credit, payment_method, depositor, bank_account, receipt_type, receipt_method, receipt_info,
            total_price, total_deposit, delivery_fee, final_price, created_at, delivery_message, buyer_request, recipient_phone,
            guest_password
        ) VALUES (
            #{id}, #{ordererName}, #{ordererPhone}, #{email}, #{recipient}, #{postcode}, #{address}, #{detailAddress},
            #{usedCredit}, #{paymentMethod}, #{depositor}, #{bankAccount}, #{receiptType}, #{receiptMethod}, #{receiptInfo},
            #{totalPrice}, #{totalDeposit}, #{deliveryFee}, #{finalPrice}, NOW(), #{deliveryMessage}, #{buyerRequest}, #{recipientPhone},
            #{guestPassword}
        )
    </insert>

    <!-- order_items 테이블에 주문 아이템 목록 저장 -->
    <insert id="insertOrderItem" parameterType="map">
        INSERT INTO order_items (
            oid, cid, pid, category, title, quantity, price, period, size, thumbnail, 
            order_status, deposit, 
            retouch_enabled, retouch_types, retouch_note
        ) VALUES (
            #{oid}, #{item.cid}, #{item.pid}, #{item.category}, #{item.title}, #{item.quantity}, #{item.price}, 
            #{item.period}, #{item.size}, #{item.thumbnail}, #{item.orderStatus}, #{item.deposit}, 
            COALESCE(#{item.retouchEnabled}, 0), #{item.retouchTypes}, #{item.retouchNote}
        )
    </insert>

    <!-- 유저 사용한 적립금 적립 -->
    <update id="increaseCredit">
        UPDATE member
        SET credit = credit + #{credit}
        WHERE id = #{id}
    </update>

    <!-- 유저 사용한 적립금 차감 -->
    <update id="decreaseCredit">
        UPDATE member
        SET credit = credit - #{credit}
        WHERE id = #{id}
    </update>

    <!-- order_items 아이템 목록 가져오기 (orders에 들어갈) -->
    <select id="selectOrderItems" resultType="OrderItemsVo">
        SELECT 
            oi.item_id as itemId, oi.oid, oi.cid, oi.pid, oi.category, oi.title, oi.quantity, oi.price, 
            oi.period, oi.size, oi.thumbnail, oi.order_status as orderStatus, o.final_price AS finalPrice,
            oi.lease_start as leaseStart, oi.lease_end as leaseEnd, tracking_number as trackingNumber, tracking_company as trackingCompany,
            oi.retouch_enabled as retouchEnabled,
            oi.retouch_types as retouchTypes,
            oi.retouch_note as retouchNote
        FROM order_items oi join orders o
        ON oi.oid = o.oid
        WHERE oi.oid = #{oid}
    </select>

    <!-- 날짜, 타입 필터로 값 가져오기 -->
    <select id="selectOrderListWithFilter" resultMap="orderMap" resultType="com.diasec.diasec_backend.vo.OrderVo">
        SELECT * FROM orders
        WHERE id = #{id} AND created_at BETWEEN CONCAT(#{startDate}, ' 00:00:00') AND CONCAT(#{endDate}, ' 23:59:59')
        ORDER BY created_at DESC
    </select>

    <!-- 1. itemId로 oid 조회 -->
    <select id="selectOidByItemId" resultType="long">
        SELECT oid FROM order_items WHERE item_id = #{itemId}
    </select>

    <!-- 2. oid로 주문정보 + 주문상품 목록 조회 -->
    <select id="selectOrderByOid" resultMap="orderMap" parameterType="long" resultType="OrderVo">
        SELECT * FROM orders
        WHERE oid = #{oid}
        ORDER BY created_at DESC
    </select>

    <!-- 3. 상세페이지로 들어갈 itemId 개별 주문 상품 조회 -->
    <select id="selectOrderItemById" resultType="OrderItemsVo">
        SELECT 
            item_id as itemId, oid, cid, pid, category, title, quantity, price, deposit, 
            period, size, thumbnail, order_status as orderStatus, lease_start as leaseStart, lease_end as leaseEnd,
            tracking_number as trackingNumber, tracking_company as trackingCompany,
            retouch_enabled as retouchEnabled,
            retouch_types as retouchTypes,
            retouch_note as retouchNote
        FROM order_items
        WHERE item_id = #{itemId}
    </select>
    
    <!-- 모든 주문 취소 -->
    <update id="cancelAllOrderItems">
        UPDATE order_items
        SET order_status = '취소'
        WHERE oid = #{oid}
    </update>

    <!-- 주문 취소 요청 -->
    <update id="updateOrderItemsStatus">
        UPDATE order_items
        SET order_status = #{status}
        WHERE oid = #{oid}
    </update>

    <!-- 주문 반품 처리 -->
    <update id="updateClaimInfo" parameterType="OrderItemsVo">
        UPDATE order_items
        SET
            order_status = #{orderStatus},
            return_reason = #{reason},
            return_detail = #{detail},
            bank_name = #{bankName},
            account_number = #{accountNumber},
            account_holder = #{accountHolder}
        WHERE oid = #{oid} AND pid = #{pid}
    </update>

    <!-- 주문 항목 삭제 -->
    <!-- <delete id="deleteOrderItemsByOid" parameterType="long">
        DELETE FROM order_items WHERE oid = #{oid}
    </delete> -->
    
    <!-- 주문 본문 삭제 -->
    <delete id="deleteOrderByOid" parameterType="long">
        DELETE FROM orders WHERE oid = #{oid}
    </delete>

    <delete id="deleteOrdersById" parameterType="String">
        DELETE FROM orders WHERE id = #{id}
    </delete>

    <!-- 비회원 주문 비밀번호 재설정 -->
    <update id="updateGuestPassword">
        UPDATE orders
        SET guest_password = #{encodedPw}
        WHERE oid = #{oid}
    </update>

    <update id="updateRetouchInfo">
        UPDATE order_items
        SET
            retouch_enabled = #{retouchEnabled},
            retouch_types = #{retouchTypes},
            retouch_note = #{retouchNote}
        WHERE item_id = #{itemId}
    </update>

    <select id="selectOrderItemCountsByStatus" resultType="map">
        SELECT
            order_status AS status,
            COUNT(*) AS cnt
        FROM order_items
        GROUP BY order_status
    </select>
</mapper>